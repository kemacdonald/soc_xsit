---
title: "soc-xsit-fyp-analysis"
author: "Kyle MacDonald"
date: "August 16, 2014"
output: html_document
---

## Script to visualize and analyze social-xsl experiment 

Load libraries

```{r load libraries, warning=F,message=F}
library(plyr)
library(dplyr)
library(bootstrap)
library(lme4)
library(ggplot2)
source("/Users/kmacdonald/Documents/Projects/SOC_XSIT/XSIT-MIN/analysis/Ranalysis/useful.R")
```

Read in the data.

```{r read data}
read_path_fyp <- file.path("/Users", "kmacdonald", "Documents", 
                       "Projects", "SOC_XSIT", "processed_data", 
                       "adult-fyp/")

d_df <- tbl_df(read.csv(paste(read_path_fyp,
                            "soc_xsit_expt1_master.csv", sep="")))
```

Clean up dataset 

```{r clean up dataset}
d_df <- d_df %>%
        select(-X.1, -X)

d_df <- anonymize.sids(d_df, "subid")

```

## Get the number of subjects in each condition.  

```{r describe data}
d_df %>%
        group_by(condition, intervalNum, numPicN) %>%
        summarise(n_subs = n_distinct(subid))
```

## Exclude subjects who were choosing randomly during exposure trials

Flag trials on which subs chose the target of eye gaze.

```{r target of gaze}
#revalue face vid to match chosen indices
d_df$faceIdx6 <- revalue(d_df$face, c("eyes_left_90"=0, "eyes_right_90"=1, 
                                        "eyes_left"=2, "eyes_down_left"=3,
                                        "eyes_down_right"=4, "eyes_right"=5, 
                                        "eyescenter"=-1))
d.expo_df <- d_df %>%
                filter(exposureTrial == 1) %>%
                mutate(correct_exposure = ifelse(numPic == 6, 
                                                 chosenIdx == faceIdx6,
                                                 chosenIdx == faceIdx)) %>%
                select(subids, itemNum, correct_exposure)
```

## Get test trials and merge with exposure trial information. 

```{r test trials w/exposure}
d.test_df <- d_df %>%
                filter(testTrial == 1)

d.test_df <- join(d.expo_df, d.test_df, type = "full")
```

Flag subs in the social condition who performed worse than chance on exposure trials.

```{r flag subs <25% correct on exposure}
d.test_df <- d.test_df %>%
                filter(condition == "Social") %>%
                group_by(subids, numPic) %>%
                summarise(mean_acc_exp = mean(correct_exposure)) %>%
                mutate(include_expo = ifelse(numPic == 2 & mean_acc_exp > 0.5, 1, 
                                      ifelse(numPic == 4 & mean_acc_exp > 0.25, 1,
                                      ifelse(numPic == 6 & mean_acc_exp > 0.17, 1, 
                                      ifelse(numPic == 8 & mean_acc_exp > 0.125, 1, 
                                             0))))) %>%
                join(d.test_df, by = "subids", type = "full")
```

Flag trials with extremely slow or fast RTs (+/- 2SD).

```{r clean RTs}
d.test_df <- d.test_df %>%
                mutate(include_good_rt = ifelse(log(rt) > mean(log(rt)) + 2 * sd(log(rt)) |
                                                log(rt) < mean(log(rt)) - 2 * sd(log(rt)),
                                                0, 1))
```

Save cleaned data

```{r write out data file}
write.csv(d.test_df, paste(read_path_fyp, "soc_xsit_expt1_all_test.csv", sep=""),
          row.names=FALSE)
```


## Experiment FYP: Social vs. No-social, Different delays, Different number of referents

Accuracy on exposure trials.

```{r acc exposure, echo=F}
ms_exp_looks <- d.test_df %>%
                        filter(condition == "Social", include_good_rt == 1, 
                               include_expo == 1) %>%
                        group_by(numPic, intervalNum) %>%
                        summarise(accuracy_exposure = mean(correct_exposure),
                                  ci_low = ci.low(correct_exposure),
                                  ci_high = ci.high(correct_exposure))

ms_exp_looks$intervalNum <- factor(ms_exp_looks$intervalNum)

ggplot(data=ms_exp_looks, 
       aes(x=intervalNum, y=accuracy_exposure,
           fill=intervalNum)) + 
        geom_bar(stat="identity") +
        geom_errorbar(aes(ymin=accuracy_exposure-ci_low, 
                      ymax=accuracy_exposure+ci_high), width = .1) +
        geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
        scale_y_continuous(limits=c(0,1)) +
        facet_grid(. ~ numPic)
```

Accuracy on test trials, filtering out subjects who performed below chance on exposure trials.

```{r acc test subject and trial filtering}
ms_test_looks_filtered <- d.test_df %>%
      filter(include_good_rt == 1, 
             (condition == "No-Social") | 
                   (include_expo == 1 & correct_exposure == TRUE)
             ) %>%
      group_by(condition, intervalNum, numPic, trialType) %>%
      summarise(accuracy = mean(correct),
                ci_low = ci.low(correct),
                ci_high = ci.high(correct),
                exclusionary_criteria = "subject-level")

acc_test_1 <- ggplot(data=ms_test_looks_filtered, aes(x=intervalNum, y=accuracy, 
                                                      colour = condition)) + 
      geom_line(aes(linetype = trialType)) +
      geom_errorbar(aes(ymin=accuracy - ci_low, 
                        ymax=accuracy + ci_high), width = .1) +
      geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
      scale_x_continuous(limits=c(-0.5, 7.5), breaks=c(0,1,3,7)) +
      scale_y_continuous(limits=c(0,1)) +
      scale_colour_manual(values=c("firebrick1", "dodgerblue")) +
      facet_grid(. ~ numPic) + 
      xlab("Intervening Trials") + 
      ylab("Proportion Correct") +
      labs(colour = "Condition") +
      labs(linetype = "Trial Type")
```

Accuracy on test trials, without filtering subjects (only trial level filtering)

```{r acc test trial filtering}
ms_test_looks_unfiltered <- d.test_df %>%
                        filter(include_good_rt == 1, 
                               condition == "No-Social" | correct_exposure == TRUE) %>%
                        group_by(condition, intervalNum, numPic, trialType) %>%
                        summarise(accuracy = mean(correct),
                                  ci_low = ci.low(correct),
                                  ci_high = ci.high(correct),
                                  exclusionary_criteria = "trial-level")

acc_test_2 <- ggplot(data=ms_test_looks_unfiltered, aes(x=intervalNum, y=accuracy, 
                               colour = condition)) + 
                        geom_line(aes(linetype = trialType)) +
                        geom_errorbar(aes(ymin=accuracy - ci_low, 
                                      ymax=accuracy + ci_high), width = .1) +
                        geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
                        scale_x_continuous(limits=c(-0.5, 7.5), breaks=c(0,1,3,7)) +
                        scale_y_continuous(limits=c(0,1)) +
                        scale_colour_manual(values=c("firebrick1", "dodgerblue")) +
                        facet_grid(. ~ numPic) + 
                        xlab("Intervening Trials") + 
                        ylab("Proportion Correct") +
                        labs(colour = "Condition") +
                        labs(linetype = "Trial Type")
```

Now put both plots together. 

```{r joint plot, echo=F}
#join dataframes
ms_test_all <- rbind(ms_test_looks_filtered, ms_test_looks_unfiltered)

ms_test_all$exclusionary_criteria <- factor(ms_test_all$exclusionary_criteria)

acc_test_plot_all <- ggplot(data=ms_test_all, aes(x=intervalNum, y=accuracy, 
                               colour = condition)) + 
                        geom_line(aes(linetype = trialType)) +
                        geom_errorbar(aes(ymin=accuracy - ci_low, 
                                      ymax=accuracy + ci_high), width = .1) +
                        geom_hline(aes(yintercept=1/numPic), linetype = "dashed") +
                        scale_x_continuous(limits=c(-0.5, 7.5), breaks=c(0,1,3,7)) +
                        scale_y_continuous(limits=c(0,1)) +
                        scale_colour_manual(values=c("firebrick1", "dodgerblue")) +
                        facet_grid(exclusionary_criteria ~ numPic) + 
                        xlab("Intervening Trials") + 
                        ylab("Proportion Correct") +
                        labs(colour = "Condition") +
                        labs(linetype = "Trial Type")

acc_test_plot_all
```
