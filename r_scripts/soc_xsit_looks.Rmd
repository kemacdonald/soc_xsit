---
title: "Social Cross-Situational Word Learning"
author: "Kyle MacDonald"
date: "July 14, 2014"
output: html_document
---

TODO: 
- relable RT -- test and exposure columns
- reorder gazeLength factor levels for plots

Analysis code for SOC-XSIT project. 

Load libraries.

```{r load libraries, message=FALSE, warning=FALSE}
library(bootstrap)
library(lme4)
library(ggplot2)
library(arm)
library(directlabels)
library(stringr)
library(plyr)
library(reshape2)
library(car)
library(dplyr)
library(xtable)
source('/Users/Allison/soc_xsit/XSIT-MIN/useful.R')
```

Read in data. 

```{r read data}
d <- read.csv("/Users/Allison/soc_xsit/processed_data/soc_xsit_4_looks_pilot.csv")
```

Get the number of subjects in each condition.

```{r get number of subs, echo=FALSE}
numSubs <- aggregate(correct ~ subid + gazeLength + condition, data=d, FUN=mean)
numSubs.summary <- count(numSubs, vars=c("gazeLength", "condition"))
numSubs.summary
```

Subset data for analysis.

```{r subset data}
d.test <- subset(d, testTrial==1)                               # test trials
names(d.test)[names(d.test)=="rt"] <- "rt.test"
d.first.trial <- subset(d, testTrial==1 & first.trial==TRUE)    # first test trial for each sub
d.exp <- subset(d, exposureTrial==1)   # exposure trials
names(d.exp)[names(d.exp)=="rt"] <- "rt.exp"
```

Did subjects choose target of gaze on exposure trials?

```{r exposure gaze target, echo=FALSE}
## match faceIdx to chosenIdx
d.exp$faceIdx <- revalue(d.exp$face, c("silentLDlong"=2, "silentLDmedium"=2, "silentLDshort"=2, 
                                        "silentLUlong"=0, "silentLUmedium"=0, "silentLUshort"=0, 
                                        "silentRDlong"=3, "silentRDmedium"=3, "silentRDshort"=3,
                                        "silentRUlong"=1, "silentRUmedium"=1, "silentRUshort"=1, 
                                        "straightahead"=-1))
## flag as true if subs chose target of gaze
d.exp$choseSocial <- NA 
d.exp$choseSocial <- d.exp$faceIdx == d.exp$chosenIdx

## get mean chose target of gaze by trial type, gazeLength condition, and sub id
mss.exp <- aggregate(choseSocial ~ trialType + subid + gazeLength, data=d.exp, FUN=mean)
ms.exp <- aggregate(choseSocial ~  gazeLength, data=mss.exp, FUN=mean)
ms.exp$choseSocial.cih <- aggregate(choseSocial ~ gazeLength, data=mss.exp, FUN=ci.high)$choseSocial
ms.exp$choseSocial.cil <- aggregate(choseSocial ~ gazeLength, data=mss.exp, FUN=ci.low)$choseSocial

## plot accuracy for three different gaze conditions
exp.gazeLength <- factor(ms.exp$gazeLength, levels = c("Short", "Medium", "Long"))
acc_exp <- ggplot(data=ms.exp, aes(x=exp.gazeLength, y=choseSocial)) +
                geom_bar(stat="identity", fill="dodgerblue") +
                geom_errorbar(aes(ymin=choseSocial-choseSocial.cil, ymax=choseSocial+choseSocial.cih),
                              width=.2) +
                ylim(0,1) +
                xlab("Gaze Length") +
                ylab("Proportion of Subjects Chose Gaze Target") +
                theme_bw() 
acc_exp
```

Now subset test trials to include only those on which participants chose the target of gaze on exposure.

```{r clean test trials}
d.choseSocial <- subset(d.exp, select=c("subid", "itemNum",
                                        "choseSocial", "rt.exp"))   # exposure trials chose gazeTar

d.test.gazeTar <- merge(d.test, d.choseSocial, 
                             by=c("subid", "itemNum"), 
                             all=TRUE)                          # test trials with exp trial info

d.test.choseGazeTar <- subset(d.test.gazeTar, 
                              choseSocial == TRUE, 
                              select=c(subid:rt.exp))             # test trils: just chose gazeTar on exp


```

Clean out trials with extremely slow RTs (+/- 2SD).

```{r clean RTs}
d.test.choseGazeTar$correct[log(d.test.choseGazeTar$rt.test) > mean(log(d.test.choseGazeTar$rt.test)) + 2* sd(log(d.test.choseGazeTar$rt.test)) | log(d.test.choseGazeTar$rt.test) < mean(log(d.test.choseGazeTar$rt.test)) - 2* sd(log(d.test.choseGazeTar$rt.test))] <- NA
```

Accuracy on test trials (Same/Switch).

```{r acc on test trials, echo=FALSE, warning=FALSE, message=FALSE}
# now aggregate to get means 
mss.gaze.tar <- aggregate(correct ~ trialType + gazeLength + subid, data=d.test.choseGazeTar, 
                          FUN=mean, na.action = na.omit)

ms.gaze.tar <- aggregate(correct ~ trialType + gazeLength, data=mss.gaze.tar, 
                         FUN=mean, na.action = na.omit)

ms.gaze.tar$corr.cih <- aggregate(correct ~ trialType + gazeLength, data=mss.gaze.tar, 
                                  FUN=ci.high, na.action = na.omit)$correct

ms.gaze.tar$corr.cil <- aggregate(correct ~ trialType + gazeLength, 
                                  data=mss.gaze.tar, FUN=ci.low, na.action = na.omit)$correct

# plot accuracy by gazeLength and trialType
tar.gazeLength <- factor(ms.gaze.tar$gazeLength, c("Short", "Medium", "Long"))
acc_plot <- qplot(data=ms.gaze.tar,x=tar.gazeLength, y=correct, linetype=trialType, 
                  ymin=correct-corr.cil, ymax=correct+corr.cih,
                    colour=gazeLength, 
                    geom=c("pointrange", "line"),
                    position=position_dodge(width=.02)) +
        scale_y_continuous(limits = c(0,1),breaks=c(0,.25,.5,.75,1),
                       name = "Prop. Choosing Repeated Referent") +
        geom_hline(aes(yintercept=1/4),lty=2)

acc_plot

```

RT on exposure trials.

```{r RT on exposure trials}
mss.exp.rt <- aggregate(rt ~  gazeLength + subid, data=d.exp, FUN=mean)

# remove +/- 2SD
mss.exp.rt$rt[log(mss.exp.rt$rt) > mean(log(mss.exp.rt$rt)) + 2* sd(log(mss.exp.rt$rt)) | 
                log(mss.exp.rt$rt) < mean(log(mss.exp.rt$rt)) - 2* sd(log(mss.exp.rt$rt))] <- NA
ms.exp.rt <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=mean)
ms.exp.rt$rt.cih <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=ci.high)$rt
ms.exp.rt$rt.cil <- aggregate(rt ~ gazeLength, data=mss.exp.rt, FUN=ci.low)$rt

## plots mean reaction time for the different exposure conditions 
exprt.gazeLength <- factor(ms.exp.rt$gazeLength, c("Short", "Medium", "Long"))
rt_exp <- ggplot(data=ms.exp.rt, aes(x=exprt.gazeLength, y=rt, fill=gazeLength)) +
                geom_bar(stat="identity") +
                geom_errorbar(aes(ymin=rt-rt.cil, ymax=rt+rt.cih,),
                              width=.2) +
                xlab("Gaze Length") +
                ylab("Reaction Time") +
                theme_bw() 

rt_exp
```

RT on test trials.

```{r RT on test trials}
mss.test.rt <- aggregate(rt.test ~  gazeLength + trialType + subid, data=d.test.choseGazeTar, FUN=mean)
# remove +/- 2SD
mss.test.rt$rt[log(mss.test.rt$rt) > mean(log(mss.test.rt$rt)) + 2* sd(log(mss.test.rt$rt)) | 
                log(mss.test.rt$rt) < mean(log(mss.test.rt$rt)) - 2* sd(log(mss.test.rt$rt))] <- NA
ms.test.rt <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=mean)
ms.test.rt$rt.cih <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=ci.high)$rt
ms.test.rt$rt.cil <- aggregate(rt ~ gazeLength + trialType, data=mss.test.rt, FUN=ci.low)$rt

testrt.gazeLength <- factor(ms.test.rt$gazeLength, c("Short", "Medium", "Long"))

rt_test_plot <- qplot(data=ms.test.rt, x=testrt.gazeLength, y=rt, linetype=trialType,
                      ymin=rt-rt.cil, ymax=rt+rt.cih,
                      colour=gazeLength,
                      geom=c("pointrange", "line"),
                      position=position_dodge(width=.02))

rt_test_plot
```

